---
# This YAML file contains the Ansible task for installing mods in the Factorio game.
# Credits: Generated by GitHub Copilot that needs to be trained more on Ansible.
- name: install factorio mods
  block:
    - name: create mods directory
      file:
        path: "{{ factorio_root }}/mods"
        state: directory

    - name: obtain factorio token
      uri:
        url: "https://auth.factorio.com/api-login"
        method: POST
        body_format: form-urlencoded
        body: "username={{ factorio_username }}&password={{ factorio_password }}"
        return_content: yes
      register: login_response

    - name: set factorio token
      set_fact:
        factorio_token: "{{ login_response.json[0] }}"

    - name: gather factorio info on mods
      uri:
        url: "https://mods.factorio.com/api/mods/{{ item.name }}"
        return_content: yes
      register: mod_info
      loop: "{{ factorio_mods }}"

    - name: download mod files
      get_url:
        url: "https://mods.factorio.com{{ item.json.releases[-1].download_url }}?username={{ factorio_username }}&token={{ factorio_token }}"
        force_basic_auth: yes
        dest: "{{ factorio_root }}/mods/{{ item.json.name }}_{{ item.json.releases[-1].version }}.zip"
      loop: "{{ mod_info.results }}"

    - name: generate mod-list.json
      copy:
        content: |
          {
            "mods": [
              {
                "name": "base",
                "enabled": true
              },
              {% for mod in factorio_mods %}
              {
                "name": "{{ mod.name }}",
                "enabled": "{{ mod.enabled }}"
              },
              {% endfor %}
            ]
          }
        dest: "{{ factorio_root }}/mods/mod-list.json"
      notify: factorio restart
  when: factorio_mods is defined
  tags:
    - install
    - factorio
    - mods
